<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ’Œ</title>
<style>
/* --- keep all your original CSS here exactly as-is --- */
/* I am not pasting your entire CSS again for sanity.
Just keep your full <style> block unchanged. */
</style>
</head>

<body>

<div id="envelopeStage">
  <div class="envelope" id="envelope">
    <div class="envelope-heart">
      â¤ï¸
    </div>
    <div class="envelope-flap"></div>
  </div>
</div>

<div class="container">
  <div class="modal-inner">

    <!-- INTRO -->
    <div id="stageIntro" class="modal-view visible">
      <h1 class="modal-title">è¦ªæ„›çš„ä½³è‡»â€¦</h1>
      <p>ç¥å¯«çš„æ•…äº‹ï¼Œç¸½æ˜¯æ¯”æˆ‘å€‘æƒ³åƒçš„é‚„è¦ç¾ã€‚</p>
      <p style="margin-top:12px;">
        æˆ‘æ²’æœ‰é æ–™æœƒé‡è¦‹å¦³ï¼Œ<br>
        ä½†æˆ‘æ¯å¤©éƒ½ç‚ºå¦³æ„Ÿè¬ç¥‚ã€‚
      </p>
      <button class="yes-only-btn" onclick="goToStage('stageQuiz')">ç¹¼çºŒ</button>
    </div>

    <!-- QUIZ -->
    <div id="stageQuiz" class="modal-view">
      <h1 class="modal-title">å°æ¸¬é©— ğŸ˜</h1>
      <p id="quizQuestion"></p>
      <div id="quizButtons"></div>
      <p id="quizFeedback" style="margin-top:12px;"></p>
    </div>

    <!-- PUZZLE -->
    <div id="stagePuzzle" class="modal-view">
      <h1 class="modal-title">Dear ä½³è‡»...</h1>
      <div class="puzzle-container" id="puzzleContainer">
        <div class="puzzle-grid-wrap" id="puzzleGridWrap">
          <div class="puzzle-grid" id="puzzleGrid"></div>
          <div class="puzzle-full-image-overlay" id="puzzleFullImageOverlay">
            <img src="images/full-image.png">
          </div>
        </div>
      </div>

      <p id="storyText" style="margin-top:16px;"></p>

      <div class="puzzle-reveal-text" id="puzzleRevealText">
        <p class="complete-line">å¦³æ˜¯æˆ‘çš„å¹¾åˆ†ä¹‹å¹¾ â˜ºï¸</p>
        <p class="valentine-question">å¦³é¡˜æ„ç•¶æˆ‘ä»Šå¹´çš„ Valentine å—ï¼ŸğŸ¥º</p>
        <input id="typeYes" placeholder="è«‹è¼¸å…¥ï¼šé¡˜æ„">
        <br>
        <button class="yes-only-btn" onclick="checkYes()">é€å‡º</button>
      </div>
    </div>

    <!-- SUCCESS -->
    <div id="stageSuccess" class="modal-view">
      <p class="modal-title">
        æ„Ÿè¬ç¥è®“æˆ‘å€‘ç›¸é‡ï¼Œ<br>
        æˆ‘çœŸçš„å¾ˆçæƒœå¦³ ğŸ™‡ğŸ»â€â™‚ï¸
      </p>
      <img src="giphy.gif" style="max-width:300px;border-radius:12px;">
      <button class="reset-btn" onclick="location.reload()">Reset</button>
    </div>

  </div>
</div>

<script>
/* ---------- STAGE CONTROL ---------- */
function goToStage(id) {
  document.querySelectorAll('.modal-view').forEach(v => v.classList.remove('visible'));
  document.getElementById(id).classList.add('visible');
}

/* ---------- ENVELOPE ---------- */
const envelope = document.getElementById("envelope");
envelope.onclick = () => {
  document.getElementById("envelopeStage").style.display = "none";
  document.body.classList.add("show-modal");
};

/* ---------- QUIZ ---------- */
const quizData = [
  { q:"æˆ‘å€‘ç¬¬ä¸€æ¬¡èªè­˜æ˜¯åœ¨å“ªè£¡ï¼Ÿ", options:["æ•™æœƒ","ç¶²è·¯","æœ‹å‹ä»‹ç´¹"], correct:1 },
  { q:"æˆ‘æœ€å¸¸é»çš„é£²æ–™æ˜¯ï¼Ÿ", options:["å¥¶èŒ¶","å’–å•¡","æ°´"], correct:0 }
];
let quizStep = 0;

function loadQuiz() {
  const q = quizData[quizStep];
  quizQuestion.textContent = q.q;
  quizButtons.innerHTML = "";
  q.options.forEach((t,i)=>{
    const b=document.createElement("button");
    b.className="yes-only-btn";
    b.style.margin="6px";
    b.textContent=t;
    b.onclick=()=>checkQuiz(i);
    quizButtons.appendChild(b);
  });
}
function checkQuiz(i){
  if(i!==quizData[quizStep].correct){
    quizFeedback.textContent="å·®ä¸€é» ğŸ˜… å†è©¦è©¦çœ‹";
    return;
  }
  quizStep++;
  if(quizStep>=quizData.length){
    goToStage("stagePuzzle");
  } else {
    quizFeedback.textContent="å°äº† ğŸ˜Œ";
    loadQuiz();
  }
}
loadQuiz();

/* ---------- PUZZLE (your logic) ---------- */
const puzzleGrid = document.getElementById("puzzleGrid");
const solution=[1,2,3,4,5,6,7,8,9];
let currentState=[...solution];
const EMPTY_PIECE=3;
let moveCount=0;

function initPuzzle(){
  for(let i=0;i<12;i++){
    const e=currentState.indexOf(EMPTY_PIECE);
    const v=getValidMoves(e);
    const r=v[Math.floor(Math.random()*v.length)];
    [currentState[e],currentState[r]]=[currentState[r],currentState[e]];
  }
  renderPuzzle();
}
function getValidMoves(i){
  const m=[],r=Math.floor(i/3),c=i%3;
  if(r>0)m.push(i-3);
  if(r<2)m.push(i+3);
  if(c>0)m.push(i-1);
  if(c<2)m.push(i+1);
  return m;
}
function renderPuzzle(){
  puzzleGrid.innerHTML="";
  currentState.forEach((p,i)=>{
    const d=document.createElement("div");
    d.className="puzzle-tile";
    if(p===EMPTY_PIECE){
      d.classList.add("empty");
    } else {
      d.style.backgroundImage=`url('images/tile-${p}.png')`;
      d.onclick=()=>moveTile(i);
    }
    puzzleGrid.appendChild(d);
  });
}
function moveTile(i){
  const e=currentState.indexOf(EMPTY_PIECE);
  if(getValidMoves(e).includes(i)){
    [currentState[e],currentState[i]]=[currentState[i],currentState[e]];
    moveCount++;
    updateStoryText();
    renderPuzzle();
    if(isSolved()) onSolved();
  }
}
function isSolved(){
  return currentState.every((v,i)=>v===solution[i]);
}
function updateStoryText(){
  if(moveCount===3) storyText.textContent="å¦³å¾ˆæº«æŸ”ã€‚";
  if(moveCount===6) storyText.textContent="ä¹Ÿå¾ˆé«”è²¼ã€‚";
  if(moveCount===9) storyText.textContent="æˆ‘çœŸçš„å¾ˆæ„›å¦³ã€‚";
}
function onSolved(){
  puzzleRevealText.classList.add("show");
}

/* ---------- YES LOCK ---------- */
function checkYes(){
  if(typeYes.value.trim()==="é¡˜æ„"){
    goToStage("stageSuccess");
  }
}

initPuzzle();
</script>
</body>
</html>
